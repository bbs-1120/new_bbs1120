# 要件定義書

**プロジェクト名**: CPN自動仕分けシステム  
**バージョン**: v1.0  
**作成日**: 2024年12月18日  
**最終更新**: 2024年12月18日

---

## 1. 目的

スプレッドシートに集約された広告運用データをもとに、CPN単位で「停止／作り替え／継続／要確認」を自動仕分けし、**明日の広告運用状態をCPNと数値だけで即判断できる状態**を構築する。

### 達成目標
- 判断基準の属人化排除
- 日次判断工数の削減
- 最終判断は中田悠太が行い、Chatworkへ共有

---

## 2. システム概要

### 2.1 システム構成

```
┌─────────────────────────────────────────────────────┐
│           Web管理画面（ブラウザでアクセス）            │
│  ・仕分け結果の一覧表示・フィルタ・検索               │
│  ・手修正機能                                        │
│  ・Chatwork送信ボタン                                │
└─────────────────────────────────────────────────────┘
                         ↕ Prisma ORM
┌─────────────────────────────────────────────────────┐
│                  PostgreSQL                          │
│  ・CPNデータ                                         │
│  ・仕分け結果                                        │
│  ・設定値                                            │
│  ・実行履歴                                          │
└─────────────────────────────────────────────────────┘
                         ↕ Google Sheets API
┌─────────────────────────────────────────────────────┐
│              Google スプレッドシート                  │
│  ・RAW（生データ）← バックオフィスがCSV吸い上げ       │
└─────────────────────────────────────────────────────┘
```

### 2.2 技術スタック

| レイヤー | 技術 | 備考 |
|----------|------|------|
| フロントエンド | **Next.js 15** | App Router |
| スタイリング | **Tailwind CSS** | - |
| ORM | **Prisma** | 型安全なDB操作 |
| データベース | **PostgreSQL** | リレーショナルDB |
| 外部連携 | **Google Sheets API** | スプレッドシート連携 |
| 通知 | **Chatwork API** | - |
| 言語 | **TypeScript** | 型安全 |
| 本番環境 | **Google Cloud** | Cloud Run / Cloud SQL 想定 |

---

## 3. 対象範囲

### 3.1 対象媒体
- Meta
- TikTok
- YouTube
- Pangle
- LINE

### 3.2 対象単位
- **CPN**（広告媒体に入稿しているCRをまとめたキャンペーン単位）

### 3.3 対象外（スコープ外）
- 広告配信設定の自動変更
- クリエイティブ評価ロジック
- 媒体APIからの直接取得（CSV吸い上げ後のシートを前提）

---

## 4. ユーザー

| 項目 | 内容 |
|------|------|
| 利用範囲 | 社内用 |
| 初期ユーザー | 中田悠太のみ |
| 将来ユーザー | 社内メンバー |
| 最大ユーザー数 | 100人 |
| 主な利用シーン | 広告運用者が翌日のSNS広告の精査や作り替え基準として利用 |

---

## 5. 前提条件

- 媒体管理画面からのCSVはバックオフィスが自動で吸い上げ済み
- 日次でスプレッドシートに反映される
- スプレッドシートのデータをPostgreSQLに同期して利用

---

## 6. CPN定義

### 6.1 CPN一意キー
```
部署_名前_案件_オファー_媒体_リンク番号_日付_記事番号_CPN名
```

### 6.2 Re判定ルール
| 条件 | 判定 |
|------|------|
| CPN名に `_Re` を含む | Reあり枠 |
| CPN名に `_Re` を含まない | Reなし枠 |

※ 部分一致判定

---

## 7. 使用指標

### 7.1 判定に使用する数値
| 指標 | 用途 |
|------|------|
| 当日消化金額 | 判定 |
| 当日利益 | 判定 |
| 直近7日間利益 | 判定 |
| 直近7日間合計ROAS | 判定 |
| CV | 判定 |
| MCV | 判定 |
| CPM | 参考 |
| CPC | 参考 |

### 7.2 運用益定義
```
運用益 = 売上 − 消化金額
```

---

## 8. 判定ロジック

### 8.1 判定優先順位（固定）
```
停止 ＞ 作り替え ＞ 継続 ＞ 要確認
```

### 8.2 連続赤字日の定義
- 広告運用開始後の連続赤字日数
- 当日を1日目としてカウント
- 利益 < 0 が連続している日数
- 途中で黒字になった場合はカウントリセット

### 8.3 仕分け条件

#### 停止（ReありCPN）
以下**いずれか**に該当した場合：
| # | 条件 |
|---|------|
| 1 | 連続赤字日数 ≥ 2 |
| 2 | 直近7日間赤字額 ≥ 40,000円 |
| 3 | 直近7日間ROAS < 105% |

#### 作り替え（ReなしCPN）
以下**いずれか**に該当した場合：
| # | 条件 |
|---|------|
| 1 | 連続赤字日数 ≥ 3 |
| 2 | 直近7日間赤字額 ≥ 40,000円 |
| 3 | 直近7日間ROAS < 105% |

#### 継続
以下**いずれか**に該当した場合：
| # | 条件 |
|---|------|
| 1 | 直近7日間利益 > 0 |
| 2 | 当日利益 > 0 |
| 3 | 直近7日間ROAS ≥ 110% |

#### 要確認
- 上記いずれにも該当しないCPN

---

## 9. データベース設計

### 9.1 テーブル構成

#### cpn_daily_data（日次データ）
| カラム名 | 型 | 説明 |
|----------|------|------|
| id | UUID | 主キー |
| cpn_key | VARCHAR | CPN一意キー |
| cpn_name | VARCHAR | CPN名 |
| media | VARCHAR | 媒体名 |
| date | DATE | データ日付 |
| spend | DECIMAL | 消化金額 |
| revenue | DECIMAL | 売上 |
| profit | DECIMAL | 利益 |
| roas | DECIMAL | ROAS |
| cv | INTEGER | CV数 |
| mcv | INTEGER | MCV数 |
| cpm | DECIMAL | CPM |
| cpc | DECIMAL | CPC |
| created_at | TIMESTAMP | 作成日時 |
| updated_at | TIMESTAMP | 更新日時 |

#### judgment_results（仕分け結果）
| カラム名 | 型 | 説明 |
|----------|------|------|
| id | UUID | 主キー |
| cpn_key | VARCHAR | CPN一意キー |
| cpn_name | VARCHAR | CPN名 |
| media | VARCHAR | 媒体名 |
| judgment_date | DATE | 判定日 |
| today_profit | DECIMAL | 当日利益 |
| profit_7days | DECIMAL | 7日間利益 |
| roas_7days | DECIMAL | 7日間ROAS |
| consecutive_loss_days | INTEGER | 連続赤字日数 |
| judgment | VARCHAR | 判定結果 |
| reasons | TEXT[] | 理由タグ |
| recommended_action | TEXT | 推奨アクション |
| manual_override | VARCHAR | 手修正結果 |
| is_send_target | BOOLEAN | 送信対象フラグ |
| created_at | TIMESTAMP | 作成日時 |
| updated_at | TIMESTAMP | 更新日時 |

#### settings（設定）
| カラム名 | 型 | 説明 |
|----------|------|------|
| id | UUID | 主キー |
| key | VARCHAR | 設定キー |
| value | VARCHAR | 設定値 |
| description | TEXT | 説明 |
| updated_at | TIMESTAMP | 更新日時 |

#### execution_logs（実行履歴）
| カラム名 | 型 | 説明 |
|----------|------|------|
| id | UUID | 主キー |
| executed_at | TIMESTAMP | 実行日時 |
| executed_by | VARCHAR | 実行者 |
| action_type | VARCHAR | 処理種別 |
| target_count | INTEGER | 対象件数 |
| rule_version | VARCHAR | ルールバージョン |
| status | VARCHAR | 実行結果 |
| error_message | TEXT | エラーメッセージ |

---

## 10. 機能要件

### 10.1 管理画面機能

| # | 機能 | 説明 |
|---|------|------|
| F-01 | ダッシュボード | 仕分け結果サマリ表示 |
| F-02 | データ同期 | スプレッドシートからDBへデータ取込 |
| F-03 | 仕分け実行 | ボタン押下で判定ロジック実行 |
| F-04 | 結果一覧表示 | CPN一覧をテーブル表示 |
| F-05 | フィルタ・検索 | 媒体、判定結果、CPN名で絞り込み |
| F-06 | 手修正 | 判定結果の手動変更 |
| F-07 | Chatwork送信 | 選択したCPNをChatworkへ通知 |
| F-08 | 設定管理 | 閾値・ルールの変更 |
| F-09 | 履歴表示 | 実行履歴・送信履歴の確認 |

### 10.2 Chatwork通知仕様

#### 送信フォーマット
```
【本日のCPN仕分け】YYYY/MM/DD

■ 停止（Reあり）
CPN名｜当日利益｜7日利益｜7日ROAS｜理由

■ 作り替え（Reなし）
CPN名｜当日利益｜7日利益｜7日ROAS｜理由

■ 継続
CPN名｜当日利益｜7日利益｜7日ROAS

■ 要確認
CPN名｜当日利益｜7日利益｜7日ROAS｜理由

▼詳細
管理画面URL
```

---

## 11. 運用フロー

```
1. バックオフィスがCSVを吸い上げ → RAWシートに反映（日次）
         ↓
2. 中田が管理画面にアクセス
         ↓
3. 「データ同期」ボタンでスプレッドシート→DB同期
         ↓
4. 「仕分け実行」ボタンを押下
         ↓
5. システムが判定ロジックを実行
         ↓
6. 結果が管理画面に表示 & DBに保存
         ↓
7. 中田が結果を確認・必要に応じて手修正
         ↓
8. 送信対象を選択して「Chatwork送信」ボタンを押下
         ↓
9. Chatworkに結果が送信される
```

---

## 12. 非機能要件

| 項目 | 要件 |
|------|------|
| 可用性 | 99.9%目標（Google Cloud SLA準拠） |
| 性能 | 100CPN以下の仕分けを10秒以内 |
| セキュリティ | 初期は認証なし（将来的に追加検討） |
| 拡張性 | 100ユーザーまで対応可能な設計 |
| 保守性 | TypeScript + Prismaによる型安全 |
| バックアップ | Cloud SQLの自動バックアップ |

---

## 13. インフラ構成（Google Cloud）

| サービス | 用途 |
|----------|------|
| Cloud Run | Next.jsアプリケーションホスティング |
| Cloud SQL (PostgreSQL) | データベース |
| Cloud Storage | 静的ファイル・バックアップ |
| Secret Manager | API キー管理 |
| Cloud Logging | ログ管理 |

---

## 14. 完成の定義（受入条件）

- [ ] 手動判断と同等の仕分け結果が再現される
- [ ] 理由タグにより判定根拠が説明できる
- [ ] 中田のみが承認・送信可能
- [ ] CPNと数値だけで翌日の運用判断が可能
- [ ] 管理画面からスプレッドシートのデータを同期できる
- [ ] 管理画面から仕分け実行ができる
- [ ] 管理画面からChatwork送信ができる
- [ ] Google Cloudにデプロイされ稼働している

---

## 15. 今後の拡張予定（Phase 2以降）

- ユーザー認証・権限管理
- 複数ユーザー対応
- 通知先のカスタマイズ
- レポート・分析機能
- モバイル対応
- 自動実行（スケジューラー）

---

## 16. 用語集

| 用語 | 説明 |
|------|------|
| CPN | キャンペーン。広告媒体に入稿しているCRをまとめた単位 |
| Re枠 | CPN名に`_Re`を含むキャンペーン。リターゲティング枠 |
| ROAS | Return On Ad Spend。広告費用対効果（売上÷消化金額×100） |
| CV | コンバージョン |
| MCV | マイクロコンバージョン |
| CPM | Cost Per Mille。1000インプレッションあたりのコスト |
| CPC | Cost Per Click。クリック単価 |
| Prisma | Node.js/TypeScript向けのORM |
| Cloud Run | Google Cloudのサーバーレスコンテナ実行環境 |
| Cloud SQL | Google Cloudのマネージドデータベースサービス |
